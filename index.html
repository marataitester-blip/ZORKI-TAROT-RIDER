<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=2.0, user-scalable=yes">
    <title>AURA - 12 (Test Stand)</title>
    <style>
        :root {
            --perla: #fdfdfa;
            --copper: #9b5a2b; /* Более контрастная медь */
            --bg: #f5f5f0;
        }

        body {
            margin: 0;
            background: var(--bg);
            color: #2c1a1a;
            font-family: "Palatino", "Georgia", serif;
            display: flex;
            flex-direction: column;
            height: 100vh;
            overflow: hidden;
        }

        .screen { display: none; flex-direction: column; height: 100%; padding: 15px; overflow-y: auto; }
        .active { display: flex; }

        h1 {
            color: var(--copper);
            text-align: center;
            font-size: 2.2rem;
            letter-spacing: 4px;
            margin: 15px 0;
            border-bottom: 2px solid var(--copper);
        }

        /* Кнопки управления */
        .big-btn {
            background: var(--copper);
            color: #fff;
            border: none;
            padding: 20px;
            border-radius: 12px;
            font-size: 1.1rem;
            font-weight: bold;
            text-transform: uppercase;
            margin: 10px 0;
            box-shadow: 0 4px 10px rgba(0,0,0,0.2);
        }

        /* Видео и фото */
        #webcam, #final-photo {
            width: 100%;
            height: 40vh;
            background: #000;
            border-radius: 8px;
            object-fit: cover;
            border: 4px solid var(--copper);
        }

        #final-photo { cursor: zoom-in; }

        /* Текст и вывод */
        textarea {
            width: 100%;
            height: 80px;
            background: var(--perla);
            border: 2px solid var(--copper);
            padding: 10px;
            font-size: 1.1rem;
            border-radius: 8px;
        }

        .result-box {
            background: var(--perla);
            border: 1px solid var(--copper);
            padding: 15px;
            margin-top: 15px;
            border-radius: 8px;
            font-size: 1.3rem; /* Крупный текст */
            line-height: 1.5;
            color: #2c1a1a;
            min-height: 100px;
        }

        .model-label {
            font-size: 0.8rem;
            font-weight: bold;
            color: var(--copper);
            margin-bottom: 5px;
            text-transform: uppercase;
        }

        .btn-row { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }
    </style>
</head>
<body>

<div id="screen-main" class="screen active">
    <h1>AURA - 12</h1>
    <textarea id="context" placeholder="О чем ваш запрос? (Контекст)"></textarea>
    <button class="big-btn" onclick="startCamera()">ВКЛЮЧИТЬ КАМЕРУ</button>
</div>

<div id="screen-camera" class="screen">
    <video id="webcam" autoplay playsinline></video>
    <button class="big-btn" onclick="takePhoto()">СДЕЛАТЬ ФОТО РАСКЛАДА</button>
    <button onclick="nav('screen-main')" style="background:none; border:none; color:var(--copper); font-weight:bold;">ОТМЕНА</button>
</div>

<div id="screen-result" class="screen">
    <img id="final-photo" onclick="this.requestFullscreen()" alt="Расклад">
    
    <div class="btn-row">
        <button class="big-btn" style="background:#4a69bd;" onclick="analyze('qwen/qwen-2.5-vl-72b-instruct:free')">QWEN Глаза</button>
        <button class="big-btn" style="background:#60a3bc;" onclick="analyze('openai/gpt-4o-mini')">GPT-4o Глаза</button>
    </div>

    <div id="output" class="result-box">
        Ожидание анализа...
    </div>

    <button class="big-btn" style="background:#333;" onclick="speak()">ОЗВУЧИТЬ</button>
    <button onclick="location.reload()" style="background:none; border:none; color:var(--copper); font-weight:bold; margin-top:20px;">НОВЫЙ КРУГ</button>
</div>

<canvas id="hidden-canvas" style="display:none;"></canvas>

<script>
    let stream;
    const video = document.getElementById('webcam');
    const canvas = document.getElementById('hidden-canvas');
    let currentPhoto = "";
    let lastText = "";

    function nav(id) {
        document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
        document.getElementById(id).classList.add('active');
    }

    async function startCamera() {
        nav('screen-camera');
        stream = await navigator.mediaDevices.getUserMedia({ 
            video: { facingMode: 'environment', width: 1280, height: 720 } 
        });
        video.srcObject = stream;
    }

    function takePhoto() {
        canvas.width = video.videoWidth;
        canvas.height = video.videoHeight;
        canvas.getContext('2d').drawImage(video, 0, 0);
        currentPhoto = canvas.toDataURL('image/jpeg', 0.8);
        document.getElementById('final-photo').src = currentPhoto;
        
        if(stream) stream.getTracks().forEach(t => t.stop());
        nav('screen-result');
    }

    async function analyze(modelId) {
        const out = document.getElementById('output');
        const context = document.getElementById('context').value;
        out.innerHTML = `<div class="model-label">${modelId}</div> Анализирую геометрию и карты...`;

        try {
            const res = await fetch('/api/analyze', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    model: modelId,
                    messages: [{ role: "user", content: [
                        { type: "text", text: `Ты модуль зрения Зоркий. Инженерный отчет по фото: 1. Какие карты Таро Уэйта видишь (название, положение, перевернутость)? 2. Как называется этот расклад геометрически? 3. Трактуй коротко исходя из контекста: ${context}` },
                        { type: "image_url", image_url: { url: currentPhoto } }
                    ]}]
                })
            });
            const data = await res.json();
            lastText = data.choices[0].message.content;
            out.innerHTML = `<div class="model-label">${modelId}</div> ${lastText.replace(/\n/g, '<br>')}`;
            speak(); // Авто-озвучка при получении результата
        } catch (e) {
            out.innerText = "Ошибка: " + e.message;
        }
    }

    function speak() {
        if (!lastText) return;
        const ut = new SpeechSynthesisUtterance(lastText);
        ut.lang = 'ru-RU';
        ut.rate = 0.9;
        window.speechSynthesis.speak(ut);
    }
</script>
</body>
</html>
