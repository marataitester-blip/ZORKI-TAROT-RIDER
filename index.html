<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>AURA - 12</title>
    <style>
        :root {
            --perlamutr: #fcfcf5;
            --copper: #b87333;
            --copper-dark: #8b4513;
            --text-dark: #3e2723;
        }

        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }

        body {
            margin: 0;
            background: var(--perlamutr);
            color: var(--text-dark);
            font-family: "Georgia", serif;
            height: 100vh;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        /* Экраны */
        .screen {
            display: none;
            flex-direction: column;
            height: 100%;
            width: 100%;
            padding: 20px;
            animation: fadeIn 0.5s ease;
        }

        .active { display: flex; }

        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }

        /* Заголовок */
        h1 {
            color: var(--copper);
            text-align: center;
            font-size: 2.5rem;
            letter-spacing: 5px;
            margin: 20px 0;
            text-shadow: 1px 1px 2px rgba(0,0,0,0.1);
        }

        /* Кнопки и выключатели */
        .big-btn {
            background: var(--copper);
            color: white;
            border: none;
            padding: 25px;
            border-radius: 50px;
            font-size: 1.2rem;
            font-weight: bold;
            box-shadow: 0 4px 15px rgba(184, 115, 51, 0.4);
            cursor: pointer;
            margin-top: 20px;
        }

        .switch-container {
            display: flex;
            justify-content: space-around;
            margin: 20px 0;
        }

        .toggle {
            display: flex;
            flex-direction: column;
            align-items: center;
            color: var(--copper-dark);
        }

        /* Камера и Фото */
        #video-preview, #final-photo {
            width: 100%;
            height: 45vh;
            background: #000;
            border-radius: 15px;
            object-fit: cover;
            border: 3px solid var(--copper);
        }

        .zoom-photo {
            cursor: zoom-in;
            transition: transform 0.3s;
        }
        .zoom-photo:active { transform: scale(1.5); z-index: 100; position: relative; }

        /* Текстовые блоки */
        textarea {
            width: 100%;
            height: 100px;
            background: rgba(255,255,255,0.5);
            border: 1px solid var(--copper);
            border-radius: 10px;
            padding: 10px;
            font-family: inherit;
            margin-bottom: 10px;
        }

        #interpretation-area {
            flex: 1;
            overflow-y: auto;
            padding: 10px;
            background: rgba(255,255,255,0.3);
            border-radius: 10px;
            margin-top: 10px;
        }

        .interpretation-text { margin-bottom: 20px; border-bottom: 1px solid #ddd; padding-bottom: 10px; }
    </style>
</head>
<body>

    <div id="screen-main" class="screen active">
        <h1>AURA - 12</h1>
        
        <textarea id="context" placeholder="Введите ваш запрос..."></textarea>

        <div class="switch-container">
            <div class="toggle">
                <span>МАРГО</span>
                <input type="checkbox" id="check-margo" checked>
            </div>
            <div class="toggle">
                <span>МЕССИР</span>
                <input type="checkbox" id="check-messire" checked>
            </div>
        </div>

        <button class="big-btn" onclick="startCamera()">ВКЛЮЧИТЬ КАМЕРУ</button>
    </div>

    <div id="screen-camera" class="screen">
        <video id="webcam" autoplay playsinline></video>
        <button class="big-btn" onclick="takePhoto()">СДЕЛАТЬ ФОТО</button>
        <button onclick="nav('screen-main')" style="background:none; border:none; color:var(--copper); margin-top:10px;">Назад</button>
    </div>

    <div id="screen-result" class="screen">
        <div style="text-align: center;">
            <img id="final-photo" class="zoom-photo" alt="Ваш расклад">
            <p style="font-size: 0.8rem; color: var(--copper);">Нажмите на фото, чтобы увеличить (Zoom)</p>
        </div>

        <div id="confirmation-block" style="background: #fff; padding: 10px; border-radius: 10px; border: 1px solid var(--copper);">
            <p id="vision-report">Определяю расклад...</p>
            <button id="btn-confirm" style="display:none; width: 100%; background: green; color: white; border: none; padding: 10px; border-radius: 5px;" onclick="proceedToInterpretation()">ПОДТВЕРЖДАЮ</button>
        </div>

        <div id="interpretation-area">
            </div>

        <button class="big-btn" onclick="nav('screen-diary')">В ДНЕВНИК</button>
    </div>

    <div id="screen-diary" class="screen">
        <h1>ДНЕВНИК</h1>
        <div id="diary-storage" style="overflow-y: auto; flex: 1;">
            </div>
        <button class="big-btn" onclick="location.reload()">НОВЫЙ РАСКЛАД</button>
    </div>

    <canvas id="hidden-canvas" style="display:none;"></canvas>

<script>
    let stream;
    const video = document.getElementById('webcam');
    const canvas = document.getElementById('hidden-canvas');
    let capturedImg = "";
    let visionAnalysis = "";

    function nav(screenId) {
        document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
        document.getElementById(screenId).classList.add('active');
    }

    async function startCamera() {
        nav('screen-camera');
        stream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: 'environment' } });
        video.srcObject = stream;
    }

    function takePhoto() {
        canvas.width = video.videoWidth;
        canvas.height = video.videoHeight;
        canvas.getContext('2d').drawImage(video, 0, 0);
        capturedImg = canvas.toDataURL('image/jpeg', 0.8);
        document.getElementById('final-photo').src = capturedImg;
        
        // Останавливаем камеру
        stream.getTracks().forEach(track => track.stop());
        
        nav('screen-result');
        startVisionAnalysis();
    }

    async function startVisionAnalysis() {
        const report = document.getElementById('vision-report');
        report.innerText = "Зоркий анализирует расклад...";
        
        try {
            const res = await fetch('/api/analyze', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    model: "google/gemini-2.0-flash-001",
                    messages: [{ role: "user", content: [
                        { type: "text", text: "Определи карты Таро Райдера-Уэйта на фото и название расклада. Напиши кратко." },
                        { type: "image_url", image_url: { url: capturedImg } }
                    ]}]
                })
            });
            const data = await res.json();
            visionAnalysis = data.choices[0].message.content;
            report.innerText = "Зоркий видит: " + visionAnalysis;
            document.getElementById('btn-confirm').style.display = "block";
        } catch (e) {
            report.innerText = "Ошибка зрения: " + e.message;
        }
    }

    async function proceedToInterpretation() {
        document.getElementById('confirmation-block').style.display = "none";
        const area = document.getElementById('interpretation-area');
        const context = document.getElementById('context').value;

        if (document.getElementById('check-margo').checked) {
            area.innerHTML += `<div class='interpretation-text'><strong>МАРГО:</strong> Думаю...</div>`;
            getInterpretation("google/gemini-pro-1.5", `Ты Марго, психолог. Трактуй расклад: ${visionAnalysis}. Вопрос: ${context}`);
        }

        if (document.getElementById('check-messire').checked) {
            area.innerHTML += `<div class='interpretation-text'><strong>МЕССИР:</strong> Анализирую...</div>`;
            getInterpretation("anthropic/claude-3.5-sonnet", `Ты Мессир, стратег. Трактуй расклад: ${visionAnalysis}. Вопрос: ${context}`);
        }
    }

    async function getInterpretation(model, prompt) {
        const res = await fetch('/api/analyze', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ model, messages: [{role:"user", content:prompt}] })
        });
        const data = await res.json();
        const text = data.choices[0].message.content;
        
        // Обновляем текст в зоне интерпретации
        const role = model.includes('gemini') ? 'МАРГО' : 'МЕССИР';
        document.getElementById('interpretation-area').innerHTML += `<div class='interpretation-text'><strong>${role}:</strong><br>${text.replace(/\n/g, '<br>')}</div>`;
    }
</script>
</body>
</html>
