<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=2.0">
    <title>AURA-12 | Journal</title>
    <style>
        :root { --perla: #fcfcf5; --copper: #b87333; --text: #2c1a1a; }
        body, html { margin: 0; padding: 0; height: 100%; width: 100%; background: var(--perla); color: var(--text); font-family: "Georgia", serif; overflow: hidden; }
        .screen { display: none; flex-direction: column; height: 100vh; width: 100vw; padding: 20px; box-sizing: border-box; }
        .active { display: flex; }
        h1 { color: var(--copper); text-align: center; font-size: 2rem; letter-spacing: 4px; margin: 5% 0; }
        .round-btn { width: 100px; height: 100px; border-radius: 50%; background: var(--copper); color: white; border: none; font-weight: bold; cursor: pointer; margin: 10px auto; box-shadow: 0 4px 15px rgba(184,115,51,0.3); }
        .action-btn { background: var(--copper); color: white; border: none; padding: 12px; border-radius: 8px; font-weight: bold; margin: 5px 0; width: 100%; }
        textarea { width: 100%; height: 80px; background: #fff; border: 1px solid var(--copper); border-radius: 12px; padding: 12px; font-size: 1rem; box-sizing: border-box; }
        #video-full { position: absolute; top: 0; left: 0; width: 100%; height: 100%; object-fit: cover; z-index: 1; }
        .cam-ui { position: absolute; bottom: 30px; left: 0; width: 100%; z-index: 2; display: flex; justify-content: center; }
        .photo-box { height: 30vh; border: 2px solid var(--copper); border-radius: 10px; overflow: hidden; position: relative; }
        #res-img { width: 100%; height: 100%; object-fit: contain; }
        #scroll-content { flex: 1; overflow-y: auto; margin-top: 10px; font-size: 1.1rem; line-height: 1.5; }
        
        /* Дневник */
        .journal-item { background: #fff; border: 1px solid var(--copper); padding: 10px; border-radius: 8px; margin-bottom: 10px; }
        .journal-date { font-size: 0.8rem; color: var(--copper); font-weight: bold; }
        .journal-img { width: 100%; height: 100px; object-fit: cover; border-radius: 4px; margin: 5px 0; }
    </style>
</head>
<body>

    <div id="sc-1" class="screen active">
        <h1>AURA - 12</h1>
        <textarea id="context" placeholder="Ваш запрос..."></textarea>
        <button class="round-btn" onclick="startCamera()">КАМЕРА</button>
        <button class="action-btn" style="background:#444;" onclick="openJournal()">ДНЕВНИК (7 ДНЕЙ)</button>
    </div>

    <div id="sc-2" class="screen" style="padding:0;">
        <video id="video-full" autoplay playsinline></video>
        <div class="cam-ui"><button class="round-btn" style="border:4px solid #fff;" onclick="takePhoto()">СНЯТЬ</button></div>
    </div>

    <div id="sc-3" class="screen">
        <div class="photo-box"><img id="res-img"></div>
        <div id="scroll-content">
            <div id="status" style="color:var(--copper); font-style:italic;">Зоркий изучает...</div>
            <div id="out"></div>
        </div>
        <button class="action-btn" id="share-btn" style="display:none;" onclick="shareResult()">ПОДЕЛИТЬСЯ</button>
        <button class="action-btn" style="background:#333;" onclick="location.reload()">НА ГЛАВНУЮ</button>
    </div>

    <div id="sc-4" class="screen">
        <h1>ДНЕВНИК</h1>
        <div id="journal-list" style="flex:1; overflow-y:auto;"></div>
        <button class="action-btn" onclick="nav('sc-1')">НАЗАД</button>
    </div>

    <canvas id="canvas" style="display:none;"></canvas>

<script>
    let stream;
    const v = document.getElementById('video-full');
    const c = document.getElementById('canvas');
    let imgData = "";
    let currentLog = {};

    function nav(id) { document.querySelectorAll('.screen').forEach(s => s.classList.remove('active')); document.getElementById(id).classList.add('active'); }

    async function startCamera() {
        nav('sc-2');
        stream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: 'environment', width: 1280 } });
        v.srcObject = stream;
    }

    function takePhoto() {
        c.width = v.videoWidth; c.height = v.videoHeight;
        c.getContext('2d').drawImage(v, 0, 0);
        imgData = c.toDataURL('image/jpeg', 0.6); // Сжатие для экономии места
        document.getElementById('res-img').src = imgData;
        if(stream) stream.getTracks().forEach(t => t.stop());
        nav('sc-3');
        runAnalysis();
    }

    async function runAnalysis() {
        const out = document.getElementById('out');
        const st = document.getElementById('status');
        const ctx = document.getElementById('context').value;
        try {
            const res = await fetch('/api/analyze', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    model: "google/gemini-2.0-flash-001",
                    messages: [{ role: "user", content: [
                        { type: "text", text: `Зоркий, назови карты Таро и тип расклада. Трактуй для запроса: ${ctx}` },
                        { type: "image_url", image_url: { url: imgData } }
                    ]}]
                })
            });
            const data = await res.json();
            const text = data.choices[0].message.content;
            st.innerText = "Анализ завершен";
            out.innerHTML = text.replace(/\n/g, '<br>');
            document.getElementById('share-btn').style.display = 'block';
            
            saveToJournal(ctx, text, imgData);
        } catch (e) { st.innerText = "Ошибка: " + e.message; }
    }

    function saveToJournal(q, a, img) {
        let logs = JSON.parse(localStorage.getItem('aura_logs') || '[]');
        const entry = { date: Date.now(), query: q, answer: a, image: img };
        logs.unshift(entry);
        localStorage.setItem('aura_logs', JSON.stringify(logs));
        cleanOldLogs();
    }

    function cleanOldLogs() {
        let logs = JSON.parse(localStorage.getItem('aura_logs') || '[]');
        const weekAgo = Date.now() - (7 * 24 * 60 * 60 * 1000);
        logs = logs.filter(item => item.date > weekAgo);
        localStorage.setItem('aura_logs', JSON.stringify(logs));
    }

    function openJournal() {
        cleanOldLogs();
        const list = document.getElementById('journal-list');
        const logs = JSON.parse(localStorage.getItem('aura_logs') || '[]');
        list.innerHTML = logs.length ? '' : '<p style="text-align:center;">Пусто</p>';
        logs.forEach(log => {
            const d = new Date(log.date).toLocaleString('ru-RU');
            list.innerHTML += `
                <div class="journal-item">
                    <div class="journal-date">${d}</div>
                    <img src="${log.image}" class="journal-img">
                    <div style="font-weight:bold; margin:5px 0;">${log.query}</div>
                    <div style="font-size:0.9rem; max-height:100px; overflow:hidden;">${log.answer}</div>
                    <button class="action-btn" style="padding:5px; font-size:0.7rem;" onclick="shareText('${log.answer.replace(/'/g, "")}')">КОПИРОВАТЬ ТЕКСТ</button>
                </div>`;
        });
        nav('sc-4');
    }

    function shareText(txt) {
        navigator.clipboard.writeText(txt);
        alert("Текст скопирован");
    }

    async function shareResult() {
        const outText = document.getElementById('out').innerText;
        if (navigator.share) {
            navigator.share({ title: 'AURA-12 Расклад', text: outText });
        } else { shareText(outText); }
    }
</script>
</body>
</html>
